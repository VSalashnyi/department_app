<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Department Application</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
</head>
<body>
    <nav>

    </nav>
    <div id="app">

    </div>

    <!-- Modal -->
    <div class="modal fade" id="departmentModal" tabindex="-1" role="dialog" aria-labelledby="departmentModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="departmentModalLabel">Add new department</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="dep_name">Name of department:</label>
                            <input class="form-control" id="dep_name" placeholder="Enter the name of department...">
                        </div>
                        <div class="form-group">
                            <label for="dep_head_name">Head name:</label>
                            <input class="form-control" id="dep_head_name" placeholder="Enter the name of department head...">
                        </div>
                        <div class="form-group">
                            <label for="dep_description">Department description:</label>
                            <textarea name="" id="dep_description" placeholder="Enter the department description..." class="form-control" cols="30" rows="10"></textarea>
                        </div>
                        <!--<button type="submit" class="btn btn-primary">Submit</button>-->

                        <div class="modal-footer">
                            <button type="submit" id="add_department" data-dismiss="modal" class="btn btn-primary">Add</button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="workerModal" tabindex="-1" role="dialog" aria-labelledby="workerModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="workerModalLabel">Add new worker</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="worker_first_name">First name</label>
                            <input class="form-control" id="worker_first_name" placeholder="Enter employer's first name">
                        </div>
                        <div class="form-group">
                            <label for="worker_second_name">Second name</label>
                            <input class="form-control" id="worker_second_name" placeholder="Enter employers's second name...">
                        </div>
                        <div class="form-group">
                            <label for="worker_date">Date of birth:</label>
                            <input class="form-control" type="date" id="worker_date" placeholder="Enter employer's date pf birth">
                        </div>
                        <div class="form-group">
                            <label for="worker_salary">Salary</label>
                            <input class="form-control" type="number"  id="worker_salary" placeholder="Enter employer's salary">
                        </div>
                        <!--<button type="submit" class="btn btn-primary">Submit</button>-->

                        <div class="modal-footer">
                            <button type="submit" id="add_worker"data-dismiss="modal" class="btn btn-primary">Add Worker</button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="editWorkerModal" tabindex="-1" role="dialog" aria-labelledby="editWorkerModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editWorkerModalLabel">Change information:</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label for="edit_worker_first_name">First name</label>
                                <input class="form-control" id="edit_worker_first_name" placeholder="Enter employer's first name">
                            </div>
                            <div class="form-group">
                                <label for="edit_worker_second_name">Second name</label>
                                <input class="form-control" id="edit_worker_second_name" placeholder="Enter employers's second name...">
                            </div>
                            <div class="form-group">
                                <label for="edit_worker_date">Date of birth:</label>
                                <input class="form-control" type="date" id="edit_worker_date" placeholder="Enter employer's date pf birth">
                            </div>
                            <div class="form-group">
                                <label for="edit_worker_salary">Salary</label>
                                <input class="form-control" type="number" id="edit_worker_salary" placeholder="Enter employer's salary">
                            </div>
                            <!--<button type="submit" class="btn btn-primary">Submit</button>-->
    
                            <div class="modal-footer">
                                <button type="submit" id="edit_worker" data-dismiss="modal" class="btn btn-primary">Save</button>
                            </div>
                        </form>
                    </div>
    
                </div>
            </div>
        </div>

        <script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
    <script>

        var state,
            current_page,
            current_item;

        window.onload = function() {
             //fetching data
            fetch('http://www.mocky.io/v2/5c221bc83500007400d553d7')
                .then(res => res.json())
                .then(data => {
                    state = data;
                    buildNavigation(data);
                    render('');
                });
            }


        function buildNavigation(data) {
            //navigation menu clearing
            $('nav').empty();

            //creating buttons
            data.forEach(chunk => {
                $('nav').append(`<button route="/${chunk.department.toLowerCase()}"
                                               class="btn btn-secondary m-3">${chunk.department}</button>`);
            })

            //add "+" button
            $('nav').append(`<button class="btn btn-warning m-3" data-toggle="modal" data-target="#departmentModal">+</button>`);

            //adding event on navigation button click
            Array.from(document.querySelectorAll('[route]')).forEach(btn => {
                btn.addEventListener('click', navigate, false);
            });
        }


        function navigate(e) {
            render(e.target.innerHTML.toLowerCase());
            //current page updating
            current_page = e.target.attributes[0].value.substring(1);
            window.history.pushState(
                {},
                e.target.attributes[0].value,
                e.target.attributes[0].value
            );
        }

        function render(param) {
            if (param == '') {
                $('#app').html('<div class="jumbotron">' +
                    '<h1 class="display-4">Choose department you are interesting in, or add your own.</h1>' +
                    '</div>');
            } else if (param == 'oops') {
                $('#app').html('<div class="jumbotron">' +
                    '<h1 class="display-4">No department left. Add new department.</h1>' +
                    '</div>');
            } else {
                var current_department = state.filter(data => data.department.toLowerCase() == param)[0];
                $('#app').empty();

                $('<div/>').addClass('jumbotron')
                    .appendTo('#app');


                $('<h3/>').addClass('display-4 d-inline')
                    .html(current_department.department)
                    .appendTo('.jumbotron');


                $('<button/>').addClass('btn btn-danger ml-5 mb-3')
                    .text('Delete')
                    .click(() => {
                        state = state.filter(item =>
                            item.department !== current_department.department
                        );
                        buildNavigation(state);
                        if (state.length) {
                            current_page = state[state.length - 1].department.toLowerCase();
                            window.history.pushState(
                                {},
                                current_page,
                                current_page
                            );
                            render(state[state.length - 1].department.toLowerCase());
                        } else {
                            window.history.pushState(
                                {},
                                '/oops',
                                '/oops'
                            );
                            render('oops');
                        }
                    }).appendTo('.jumbotron');

                $('<p/>').html('Head of department - <b>' + current_department.head + '</b>')
                    .appendTo('.jumbotron');

                $('<p/>').html('Avarage salary : ' + avarageSalary(current_department))
                    .appendTo('.jumbotron')


                $('<hr/>').addClass('my-4')
                    .appendTo('.jumbotron');

                $('<p/>').html(current_department.description)
                    .appendTo('.jumbotron');

                $('<h3/>').html('Employers:')
                    .appendTo('.jumbotron');


                var $table = $('<table/>').addClass('table');
                if (current_department.workers.length == 0) {
                    $table.append("You have not any workers");
                } else {
                    current_department.workers.forEach(worker => {
                        $table.append(`<tr>
                                                <td>${worker.firstName}</td>
                                                <td>${worker.secondName}</td>
                                                <td>${worker.date}</td>
                                                <td>${worker.salary}</td>
                                                <td><button route="${worker.id}" class="btn btn-warning" data-toggle="modal" data-target="#editWorkerModal" >Edit</button>
                                                <button del_id="${worker.id}" class="btn btn-danger">Delete</button></td>
                                             </tr>`)
                    })
                }
                $('.jumbotron').append($table);

                $('<button/>').addClass('btn btn-success')
                    .text('Add New Worker')
                    .attr('data-toggle', 'modal')
                    .attr('data-target', '#workerModal')
                    .appendTo('.jumbotron');

                (Array.from(document.querySelectorAll('table tr td button[route]'))).forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        current_item = e.target.attributes[0].value;
                        $('#edit_worker_first_name').val(state.filter(dep => dep.department.toLowerCase() == current_page)[0].workers.filter(worker => worker.id == e.target.attributes[0].value)[0].firstName);
                        $('#edit_worker_second_name').val(state.filter(dep => dep.department.toLowerCase() == current_page)[0].workers.filter(worker => worker.id == e.target.attributes[0].value)[0].secondName);
                        $('#edit_worker_date').val(state.filter(dep => dep.department.toLowerCase() == current_page)[0].workers.filter(worker => worker.id == e.target.attributes[0].value)[0].date);
                        $('#edit_worker_salary').val(state.filter(dep => dep.department.toLowerCase() == current_page)[0].workers.filter(worker => worker.id == e.target.attributes[0].value)[0].salary);

                    });
                });


                (Array.from(document.querySelectorAll('table tr td button[del_id]'))).forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        state = state.map(dep => {
                            if (dep.department.toLowerCase() == current_page) {
                                return {
                                    ...dep,
                                    workers: dep.workers.filter(worker => {
                                        if (worker.id != e.target.attributes[0].value) {
                                            return worker;
                                        }
                                    })
                                }
                            } else {
                                return dep;
                            }
                        })
                        render(current_page)
                    });
                });

            }

        }

        function avarageSalary(depart){
            var tmp = 0;
            console.log(depart);
            var salaries = depart.workers.map(worker => worker.salary);
            salaries.forEach(salary => tmp += salary);

            return Math.round(tmp/salaries.length);
            //return data.filter(dep => dep.department.toLowerCase() == current_page).workers;
        }


        $('#add_department').click((e) => {
            //adding new department
            state.push({
                id: state.length ? state[state.length - 1].id + 1 : 1,
                department: $('#dep_name').val(),
                description: $('#dep_description').val(),
                head: $('#dep_head_name').val(),
                workers: []
            });

            //clearing input fields
            $('#dep_name, #dep_head_name, #dep_description').val('');

            //navigation rebuilding
            buildNavigation(state);
            e.preventDefault();
        })


        $('#add_worker').click((e) => {
            state = state.map(item => {
                if(item.department.toLowerCase() == current_page){
                    item.workers.push({
                        id: item.workers.length ? item.workers[item.workers.length - 1].id + 1 : 1,
                        firstName: $('#worker_first_name').val(),
                        secondName: $('#worker_second_name').val(),
                        date: $('#worker_date').val(),
                        salary: +$('#worker_salary').val()
                    })
                    return item;
                } else {
                    return item;
                }
            });


            $('#worker_first_name, #worker_second_name, #worker_date, #worker_salary').val('');
            render(current_page);
            e.preventDefault();
        })

        //save worker(edit)
        $('#edit_worker').click(() => {
            state = state.map(dep => {
                if(dep.department.toLowerCase() == current_page){
                    return {
                        ...dep,
                        workers: dep.workers.map(worker => {
                            if(worker.id == current_item){
                                return {
                                    id:worker.id,
                                    firstName:$('#edit_worker_first_name').val(),
                                    secondName:$('#edit_worker_second_name').val(),
                                    date:$('#edit_worker_date').val(),
                                    salary: +$('#edit_worker_salary').val()
                                }
                            } else {
                                return worker;
                            }
                        })
                    }
                } else {
                    return dep;
                }
            })
            render(current_page);
        });

        window.onpopstate = function(){
                current_page = document.location.pathname.substring(1);
                console.log(document.location.pathname.substring(1));
                render(current_page);
        }

        window.onbeforeunload = function(){
            window.history.pushState(
                {},
                '/',
                '/'
            );
        }()

    </script>
</body>
</html>